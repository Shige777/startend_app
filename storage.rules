rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Profile images
    match /profiles/{fileName} {
      // プロフィール画像の読み取り：認証済みユーザーのみ
      allow read: if request.auth != null;
      
      // プロフィール画像のアップロード：認証済みユーザーのみ、ファイル制限あり
      allow write: if request.auth != null && 
        isValidImageFile() &&
        isValidFileSize(10 * 1024 * 1024); // 10MB制限
    }
    
    // Post images
    match /posts/{fileName} {
      // 投稿画像の読み取り：認証済みユーザーのみ
      allow read: if request.auth != null;
      
      // 投稿画像のアップロード：認証済みユーザーのみ、ファイル制限あり
      allow write: if request.auth != null && 
        isValidImageFile() &&
        isValidFileSize(10 * 1024 * 1024); // 10MB制限
    }
    
    // Community images
    match /communities/{fileName} {
      // コミュニティ画像の読み取り：認証済みユーザーのみ
      allow read: if request.auth != null;
      
      // コミュニティ画像のアップロード：認証済みユーザーのみ、ファイル制限あり
      allow write: if request.auth != null && 
        isValidImageFile() &&
        isValidFileSize(5 * 1024 * 1024); // 5MB制限
    }
    
    // Helper functions
    function isValidImageFile() {
      // 画像ファイルの形式をチェック
      return request.resource.contentType.matches('image/.*') &&
        request.resource.contentType in ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    }
    
    function isValidFileSize(maxSize) {
      // ファイルサイズをチェック
      return request.resource.size <= maxSize;
    }
  }
} 